<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feeding Plan Browser App</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; }
h1 { text-align: center; color: #2a6ebb; font-size: 1.5em; }
#loading { text-align: center; margin: 20px 0; display: none; }
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #2a6ebb;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
#totalHeadcount { font-size: 16px; margin-bottom: 15px; text-align: center; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; display: block; overflow-x: auto; }
th, td { border: 1px solid #444; padding: 8px; text-align: center; min-width: 100px; }
th { background: #2a6ebb; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input[type="number"] { width: 70px; padding: 5px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
input[type="number"]:focus { border-color: #2a6ebb; outline: none; background-color: #fff; }
button { margin-top: 15px; padding: 10px; font-size: 16px; background-color: #2a6ebb; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
button:hover { background-color: #1f539d; }
#planOutput { margin-top: 20px; background: #fff; padding: 15px; border: 1px solid #ccc; }
#planOutput table th:nth-child(4), #planOutput table td:nth-child(4) { min-width: 120px; } /* Total column */
#planOutput table th:nth-child(2), #planOutput table td:nth-child(2) { min-width: 80px; } /* % column */
@media (max-width: 500px) { button { width: 100%; margin-top: 10px; } }
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: white !important; }
  table th { background-color: #2a6ebb !important; color: white !important; }
  tr:nth-child(even) { background-color: #f9f9f9 !important; }
  button, #inputs, #loading { display: none !important; }
}
</style>
</head>
<body>

<h1>New Blainslie Feeding Plan</h1>
<div id="loading"><div class="spinner"></div> Loading sheds...</div>
<div id="totalHeadcount">Total Headcount: 0</div>
<div id="inputs"></div>
<button onclick="generatePlan()">Generate Plan</button>
<button onclick="printPlan()">Print / Save as PDF</button>

<div id="planOutput"></div>

<script>
const MAX_BATCH = 2100;
const RATIONS_URL = "https://script.google.com/macros/s/AKfycbz7xmhtWaSwMcKVqZuuSo1eIAGOTKjThMYuDxyzKi3CNZ-uK8qAd_4ojJkVk8o0iwk/exec"; 
const YESTERDAY_URL = "https://script.google.com/macros/s/AKfycbydhGdSJ52UomMLIP1GtxyVQe2dflny8PUIC5lfv0vIiqDis_AorTZr_MsbYWaPfCCI/exec"; 
const SHEDS_URL = "https://script.google.com/macros/s/AKfycbwgA3g-Ps70NR3oBcgv11PU9wPwWg2Q5J_QHVF-aZ_Ix6G6rvOkGoYtYh1gZsL0Ed1K/exec";

let RATIONS = [], SHEDS = [];

function showLoading(show) { document.getElementById("loading").style.display = show ? "block" : "none"; }

async function fetchRations() {
  try { RATIONS = await (await fetch(RATIONS_URL + "?cacheBust=" + Date.now())).json(); }
  catch (e) { console.error("Error fetching rations:", e); RATIONS = []; }
}

async function fetchSheds() {
  try { SHEDS = await (await fetch(SHEDS_URL + "?cacheBust=" + Date.now())).json(); }
  catch (e) { console.error("Error fetching sheds:", e); SHEDS = []; }
}

async function fetchYesterdays() {
  try {
    const data = await (await fetch(YESTERDAY_URL + "?cacheBust=" + Date.now())).json();
    const yesterdays = {};
    SHEDS.forEach(s => {
      const row = data.find(r => r[0] === s.Shed);
      if (!row || row[1] === "No Data" || row[1]==null || row[1]==="") yesterdays[s.Shed] = "0";
      else if (typeof row[1] === "number") yesterdays[s.Shed] = row[1] <= 1 ? Math.round(row[1]*100).toString() : Math.round(row[1]).toString();
      else if (typeof row[1] === "string" && row[1].includes("%")) yesterdays[s.Shed] = row[1].replace("%","").trim();
      else { const num = parseFloat(row[1]); yesterdays[s.Shed] = isNaN(num) ? "0" : Math.round(num).toString(); }
    });
    return yesterdays;
  } catch (e) { console.error("Error fetching yesterday's data:", e); return {}; }
}

function computeShedTotal(shed, percent) {
  let total = 0;
  for (let r of RATIONS) {
    if (/total/i.test(r.Ingredient)) continue;
    const qty = r[shed.Ration];
    if (qty != null) total += qty * percent * shed.Headcount;
  }
  return total;
}

async function initInputs() {
  showLoading(true);
  await fetchRations();
  await fetchSheds();
  const yesterdays = await fetchYesterdays();
  const totalHeadcount = SHEDS.reduce((sum, s) => sum + (s.Headcount || 0), 0);
  document.getElementById("totalHeadcount").textContent = `Total Headcount: ${totalHeadcount}`;
  const container = document.getElementById("inputs");
  container.innerHTML = "<table><thead><tr><th>Shed</th><th>% of Target</th></tr></thead><tbody>" +
    SHEDS.map((s,i)=>{
      const placeholder = yesterdays[s.Shed] || "0";
      return `<tr><td>${s.Shed}</td><td><input type="number" inputmode="decimal" min="0" max="200" id="shed${i}" placeholder="${placeholder}"></td></tr>`;
    }).join('') +
    "</tbody></table>";
  showLoading(false);
}

function generatePlan() {
  const percentages = SHEDS.map((s,i)=>{
    let val = document.getElementById("shed"+i).value.trim();
    if (!val) val = document.getElementById("shed"+i).placeholder;
    return val; // keep as plain number
  });

  const rationGroups = {};
  SHEDS.forEach((shed,i)=>{
    const percent = parseFloat(percentages[i])/100 || 0;
    const total = computeShedTotal(shed, percent);
    if (!rationGroups[shed.Ration]) rationGroups[shed.Ration] = [];
    rationGroups[shed.Ration].push({shed, percent, total, percentStr: percentages[i]+"%"});
  });

  const allBatches = [];
  Object.entries(rationGroups).forEach(([rationType,sheds])=>{
    sheds.sort((a,b)=>b.total-a.total);
    let batches=[], current={sheds:[], total:0};
    sheds.forEach(s=>{
      if(s.total + current.total <= MAX_BATCH || current.sheds.length===0){
        current.sheds.push(s); current.total += s.total;
      } else { batches.push(current); current={sheds:[s], total:s.total}; }
    });
    if(current.sheds.length>0) batches.push(current);
    batches.forEach((batch,idx)=>{ allBatches.push({rationType, idx:idx+1, sheds:batch.sheds, total:batch.total}); });
  });

  const output = document.getElementById("planOutput");
  output.innerHTML = `<h2>Date: ${new Date().toISOString().slice(0,10)}</h2>`;
  allBatches.forEach(batch=>{
    let html = `<h3>Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg</h3>`;
    html += `<table><tr><th>Shed</th><th>%</th><th>Headcount</th><th>Total (kg)</th></tr>`;
    batch.sheds.forEach(s=>{
      html += `<tr><td>${s.shed.Shed}</td><td>${s.percentStr}</td><td>${Math.round(s.shed.Headcount)}</td><td>${Math.round(s.total)}</td></tr>`;
    });
    html += `</table>`;
    html += `<table><tr><th>Ingredient</th><th>Quantity (kg)</th></tr>`;
    const ingredientTotals = {};
    RATIONS.forEach(r=>{ if(!/total/i.test(r.Ingredient)) ingredientTotals[r.Ingredient]=0; });
    batch.sheds.forEach(s=>{
      RATIONS.forEach(r=>{
        if (/total/i.test(r.Ingredient)) return;
        const q = r[s.shed.Ration];
        if (q != null) ingredientTotals[r.Ingredient] += q * s.percent * s.shed.Headcount;
      });
    });
    Object.entries(ingredientTotals).forEach(([ing,qty])=>{
      html += `<tr><td>${ing}</td><td>${Math.round(qty)}</td></tr>`;
    });
    html += `</table>`;
    output.innerHTML += html;
  });
}

function printPlan() { window.print(); }
initInputs();
</script>
</body>
</html>