<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feeding Plan Browser App</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; color: #333; }
h1 { text-align: center; color: #2a6ebb; font-size: 1.8em; margin-bottom: 20px; }
#loading { text-align: center; margin: 20px 0; display: none; }
.spinner { border: 6px solid #f3f3f3; border-top: 6px solid #2a6ebb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

#totalHeadcount { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #444; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; border-radius: 8px; overflow: hidden; }
th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
th { background: #2a6ebb; color: white; font-weight: bold; position: sticky; top: 0; z-index: 2; }
tr:nth-child(even) { background: #f9f9f9; }
tr:hover { background: #eef5ff; }
input[type="text"] { width: 80px; padding: 8px; text-align: center; border-radius: 6px; border: 1px solid #bbb; font-size: 16px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); transition: 0.2s; }
input[type="text"]:focus { border-color: #2a6ebb; outline: none; background-color: #fff; box-shadow: 0 0 5px rgba(42,110,187,0.4); }

button { margin: 10px 5px; padding: 12px 18px; font-size: 16px; background-color: #2a6ebb; color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
button:hover { background-color: #1f539d; }
button:active { transform: scale(0.98); }

@media (max-width: 600px) {
  button { width: 100%; margin: 8px 0; font-size: 18px; }
  input[type="text"] { width: 100%; }
}
</style>
</head>
<body>

<h1>New Blainslie Feeding Plan</h1>
<div id="loading"><div class="spinner"></div> Loading sheds...</div>
<div id="totalHeadcount">Total Headcount: 0</div>
<div id="inputs"></div>
<div style="text-align:center;">
  <button onclick="generatePlan()">üöú Generate Plan</button>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const MAX_BATCH = 2100;
const RATIONS_URL = "https://script.google.com/macros/s/AKfycbz7xmhtWaSwMcKVqZuuSo1eIAGOTKjThMYuDxyzKi3CNZ-uK8qAd_4ojJkVk8o0iwk/exec"; 
const YESTERDAY_URL = "https://script.google.com/macros/s/AKfycbydhGdSJ52UomMLIP1GtxyVQe2dflny8PUIC5lfv0vIiqDis_AorTZr_MsbYWaPfCCI/exec"; 
const SHEDS_URL = "https://script.google.com/macros/s/AKfycbwgA3g-Ps70NR3oBcgv11PU9wPwWg2Q5J_QHVF-aZ_Ix6G6rvOkGoYtYh1gZsL0Ed1K/exec";

let RATIONS = [], SHEDS = [];

function showLoading(show) { document.getElementById("loading").style.display = show ? "block" : "none"; }

async function fetchRations() {
  try { RATIONS = await (await fetch(RATIONS_URL + "?cacheBust=" + Date.now())).json(); }
  catch (e) { console.error("Error fetching rations:", e); RATIONS = []; }
}

async function fetchSheds() {
  try { SHEDS = await (await fetch(SHEDS_URL + "?cacheBust=" + Date.now())).json(); }
  catch (e) { console.error("Error fetching sheds:", e); SHEDS = []; }
}

async function fetchYesterdays() {
  try {
    const data = await (await fetch(YESTERDAY_URL + "?cacheBust=" + Date.now())).json();
    const yesterdays = {};
    SHEDS.forEach(s => {
      const row = data.find(r => r[0] === s.Shed);
      if (!row || row[1] === "No Data" || row[1]==null || row[1]==="") yesterdays[s.Shed] = "0";
      else if (typeof row[1] === "number") yesterdays[s.Shed] = row[1] <= 1 ? Math.round(row[1]*100).toString() : Math.round(row[1]).toString();
      else if (typeof row[1] === "string" && row[1].includes("%")) yesterdays[s.Shed] = row[1].replace("%","").trim();
      else { const num = parseFloat(row[1]); yesterdays[s.Shed] = isNaN(num) ? "0" : Math.round(num).toString(); }
    });
    return yesterdays;
  } catch (e) { console.error("Error fetching yesterday's data:", e); return {}; }
}

function computeShedTotal(shed, percent) {
  let total = 0;
  for (let r of RATIONS) {
    if (/total/i.test(r.Ingredient)) continue;
    const qty = r[shed.Ration];
    if (qty != null) total += qty * percent * shed.Headcount;
  }
  return total;
}

async function initInputs() {
  showLoading(true);
  await fetchRations();
  await fetchSheds();
  const yesterdays = await fetchYesterdays();
  const totalHeadcount = SHEDS.reduce((sum, s) => sum + (s.Headcount || 0), 0);
  document.getElementById("totalHeadcount").textContent = `Total Headcount: ${totalHeadcount}`;
  const container = document.getElementById("inputs");
  container.innerHTML = "<table><thead><tr><th>Shed</th><th>% of Target</th></tr></thead><tbody>" +
    SHEDS.map((s,i)=>{
      const placeholder = yesterdays[s.Shed] || "0";
      return `<tr><td>${s.Shed}</td><td>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="shed${i}" placeholder="${placeholder}">
      </td></tr>`;
    }).join('') +
    "</tbody></table>";
  showLoading(false);
}

function generatePlan() {
  const percentages = SHEDS.map((s,i)=>{
    let val = document.getElementById("shed"+i).value.trim();
    if (!val) val = document.getElementById("shed"+i).placeholder;
    return val;
  });

  const rationGroups = {};
  SHEDS.forEach((shed,i)=>{
    const percent = parseFloat(percentages[i])/100 || 0;
    const total = computeShedTotal(shed, percent);
    if (!rationGroups[shed.Ration]) rationGroups[shed.Ration] = [];
    rationGroups[shed.Ration].push({shed, percent, total, percentStr: percentages[i]+"%"});
  });

  const allBatches = [];
  Object.entries(rationGroups).forEach(([rationType,sheds])=>{
    sheds.sort((a,b)=>b.total-a.total);
    let batches=[], current={sheds:[], total:0};
    sheds.forEach(s=>{
      if(s.total + current.total <= MAX_BATCH || current.sheds.length===0){
        current.sheds.push(s); current.total += s.total;
      } else { batches.push(current); current={sheds:[s], total:s.total}; }
    });
    if(current.sheds.length>0) batches.push(current);
    batches.forEach((batch,idx)=>{ allBatches.push({rationType, idx:idx+1, sheds:batch.sheds, total:batch.total}); });
  });

  // Build plan HTML
  let planHTML = `<h2>Date: ${new Date().toISOString().slice(0,10)}</h2>`;
  allBatches.forEach(batch=>{
    planHTML += `<h3>Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg</h3>`;
    planHTML += `<table><tr><th>Shed</th><th>%</th><th>Headcount</th><th>Total (kg)</th></tr>`;
    batch.sheds.forEach(s=>{
      planHTML += `<tr><td>${s.shed.Shed}</td><td>${s.percentStr}</td><td>${Math.round(s.shed.Headcount)}</td><td>${Math.round(s.total)}</td></tr>`;
    });
    planHTML += `</table>`;
    planHTML += `<table><tr><th>Ingredient</th><th>Quantity (kg)</th></tr>`;
    const ingredientTotals = {};
    RATIONS.forEach(r=>{ if(!/total/i.test(r.Ingredient)) ingredientTotals[r.Ingredient]=0; });
    batch.sheds.forEach(s=>{
      RATIONS.forEach(r=>{
        if (/total/i.test(r.Ingredient)) return;
        const q = r[s.shed.Ration];
        if (q != null) ingredientTotals[r.Ingredient] += q * s.percent * s.shed.Headcount;
      });
    });
    Object.entries(ingredientTotals).forEach(([ing,qty])=>{
      planHTML += `<tr><td>${ing}</td><td>${Math.round(qty)}</td></tr>`;
    });
    planHTML += `</table>`;
  });

  // Open new full-screen tab with plan + buttons
  const newWindow = window.open('', '_blank');
  newWindow.document.write(`
    <html>
    <head>
      <title>Feeding Plan</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
        h2, h3 { color: #2a6ebb; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background: #2a6ebb; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        button { margin: 5px; padding: 10px 15px; font-size: 16px; background-color: #2a6ebb; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background-color: #1f539d; }
      </style>
    </head>
    <body>
      <div style="text-align:center;">
        <button onclick="window.print()">üñ®Ô∏è Print</button>
        <button onclick="downloadPDF()">üìÑ Download PDF</button>
      </div>
      ${planHTML}
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script>
      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const plan = document.body;
        const canvas = await html2canvas(plan, { scale: 2 });
        const imgData = canvas.toDataURL("image/jpeg", 0.95);
        const doc = new jsPDF('p', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgProps = doc.getImageProperties(imgData);
        const imgWidth = pageWidth - 40;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        doc.addImage(imgData, 'JPEG', 20, 20, imgWidth, imgHeight);
        doc.save('feeding_plan_${new Date().toISOString().slice(0,10)}.pdf');
      }
      </script>
    </body>
    </html>
  `);
  newWindow.document.close();
}

initInputs();
</script>
</body>
</html>