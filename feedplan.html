<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Blainslie Feeding Plan</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; }
h1 { text-align: center; color: #2a6ebb; font-size: 1.5em; }
#loading { text-align: center; margin: 20px 0; display: none; }
.spinner { border: 6px solid #f3f3f3; border-top: 6px solid #2a6ebb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
#totalHeadcount { font-size: 16px; margin-bottom: 15px; text-align: center; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; display: block; overflow-x: auto; }
th, td { border: 1px solid #444; padding: 8px; text-align: center; min-width: 100px; }
th { background: #2a6ebb; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input[type="number"] { width: 80px; padding: 5px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
input[type="number"]:focus { border-color: #2a6ebb; outline: none; background-color: #fff; }
button { margin-top: 15px; padding: 10px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
#generateBtn { background-color: #2a6ebb; color: white; }
#printBtn { background-color: #4CAF50; color: white; }
#pdfBtn { background-color: #f39c12; color: white; }
button:hover { opacity: 0.85; }
#planOutput { margin-top: 20px; background: #fff; padding: 15px; border: 1px solid #ccc; }
.drag-handle { cursor: grab; color: #777; font-weight: bold; padding-right: 6px; }
.drag-handle:hover { color: #2a6ebb; }
@media (max-width: 500px) { button { width: 100%; margin-top: 10px; } }
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: white !important; }
  table th { background-color: #2a6ebb !important; color: white !important; }
  tr:nth-child(even) { background-color: #f9f9f9 !important; }
  #inputs, #loading, #generateBtn, #printBtn, #pdfBtn { display: none !important; }
}
</style>
</head>
<body>

<h1>New Blainslie Feeding Plan</h1>
<div id="loading"><div class="spinner"></div> Loading sheds...</div>
<div id="totalHeadcount">Total Headcount: 0</div>
<div id="inputs"></div>
<div style="text-align:center; margin-bottom:15px;">
  <label for="maxBatch">Max Batch Weight (kg): </label>
  <input type="number" id="maxBatch" value="2600" min="500" max="10000">
</div>
<button id="generateBtn" onclick="generatePlan()">Generate Plan</button>

<div id="planOutput" style="display:none;">
  <button id="printBtn" onclick="printPlan()">Print</button>
  <button id="pdfBtn" onclick="downloadPDF()">Download PDF</button>
</div>

<script>
// ---------- CONFIG ----------
let MAX_BATCH = 2600;
const RATIONS_URL = "https://script.google.com/macros/s/AKfycbz7xmhtWaSwMcKVqZuuSo1eIAGOTKjThMYuDxyzKi3CNZ-uK8qAd_4ojJkVk8o0iwk/exec";
const YESTERDAY_URL = "https://script.google.com/macros/s/AKfycbydhGdSJ52UomMLIP1GtxyVQe2dflny8PUIC5lfv0vIiqDis_AorTZr_MsbYWaPfCCI/exec";
const SHEDS_URL = "https://script.google.com/macros/s/AKfycbwgA3g-Ps70NR3oBcgv11PU9wPwWg2Q5J_QHVF-aZ_Ix6G6rvOkGoYtYh1gZsL0Ed1K/exec";

let RATIONS = [], SHEDS = [], PLAN = [], TOTAL_HEADCOUNT = 0;

// ---------- FETCH FUNCTIONS ----------
function showLoading(show){document.getElementById("loading").style.display=show?"block":"none";}
async function fetchRations(){try{RATIONS=await(await fetch(RATIONS_URL+"?cacheBust="+Date.now())).json();}catch(e){RATIONS=[];}}
async function fetchSheds(){try{SHEDS=await(await fetch(SHEDS_URL+"?cacheBust="+Date.now())).json();}catch(e){SHEDS=[];}}
async function fetchYesterdays(){
  try {
    const data = await (await fetch(YESTERDAY_URL+"?cacheBust="+Date.now())).json();
    const yesterdays={};
    SHEDS.forEach(s=>{
      const row=data.find(r=>r[0]===s.Shed);
      let display="0";
      if(!row||!row[1]||row[1]==="No Data") display="0";
      else {
        const raw=row[1];
        let val=typeof raw==="string"?parseFloat(raw.replace(/[%]/g,"")):raw;
        if(isNaN(val)) val=0;
        if(val>0 && val<1) val*=100;
        if(val===1) val=100;
        display=Math.round(val).toString();
      }
      yesterdays[s.Shed]=display;
    });
    return yesterdays;
  }catch(e){return{};}
}

// ---------- INPUTS ----------
function computeShedTotal(shed,percent){
  let total=0;
  for(let r of RATIONS){
    if(/total/i.test(r.Ingredient))continue;
    const qty=r[shed.Ration];
    if(qty!=null)total+=qty*percent*shed.Headcount;
  }
  return total;
}

async function initInputs(){
  showLoading(true);
  await fetchRations(); await fetchSheds();
  const yesterdays=await fetchYesterdays();
  TOTAL_HEADCOUNT=SHEDS.reduce((s,a)=>s+(a.Headcount||0),0);
  document.getElementById("totalHeadcount").textContent=`Total Headcount: ${TOTAL_HEADCOUNT}`;
  const c=document.getElementById("inputs");
  c.innerHTML=`<table><thead><tr><th>Shed</th><th>% of Target</th></tr></thead><tbody>`+
  SHEDS.map((s,i)=>`<tr><td>${s.Shed}</td><td><input type="number" id="shed${i}" placeholder="${yesterdays[s.Shed]||0}"></td></tr>`).join('')+
  `</tbody></table>`;
  showLoading(false);
}

// ---------- PLAN GENERATION ----------
function generatePlan(){
  MAX_BATCH=parseFloat(document.getElementById("maxBatch").value)||2600;
  const percentages=SHEDS.map((s,i)=>{
    const el=document.getElementById("shed"+i);
    let val=el.value.trim()||el.placeholder||"0";
    return parseFloat(val)/100||0;
  });

  const rationGroups={};
  SHEDS.forEach((shed,i)=>{
    const percent=percentages[i];
    const total=computeShedTotal(shed,percent);
    if(!rationGroups[shed.Ration])rationGroups[shed.Ration]=[];
    rationGroups[shed.Ration].push({shed,percent,total,percentStr:(percent*100).toFixed(0)+"%"});
  });

  PLAN=[];
  Object.entries(rationGroups).forEach(([rationType,sheds])=>{
    sheds.sort((a,b)=>b.total-a.total);
    let batches=[],current={sheds:[],total:0};
    sheds.forEach(s=>{
      if(s.total+current.total<=MAX_BATCH||current.sheds.length===0){current.sheds.push(s);current.total+=s.total;}
      else{batches.push(current);current={sheds:[s],total:s.total};}
    });
    if(current.sheds.length>0)batches.push(current);
    batches.forEach((b,i)=>PLAN.push({rationType,idx:i+1,sheds:b.sheds,total:b.total}));
  });

  const out=document.getElementById("planOutput");
  out.style.display="block";
  out.innerHTML=`<button id="printBtn" onclick="printPlan()">Print</button>
                 <button id="pdfBtn" onclick="downloadPDF()">Download PDF</button>
                 <h2>Date: ${new Date().toISOString().slice(0,10)}</h2>`;

  PLAN.forEach(batch=>{
    let html=`<h3>Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg</h3>`;
    html+=`<table class="shed-table"><tr><th></th><th>Shed</th><th>%</th><th>Headcount</th><th>Total (kg)</th><th>Remaining (kg)</th></tr>`;
    let remaining=batch.total;
    batch.sheds.forEach(s=>{
      remaining-=s.total;
      html+=`<tr draggable="true"><td class="drag-handle">⋮⋮</td><td>${s.shed.Shed}</td><td>${s.percentStr}</td><td>${Math.round(s.shed.Headcount)}</td><td>${Math.round(s.total)}</td><td>${Math.max(Math.round(remaining),0)}</td></tr>`;
    });
    html+=`</table>`;

    const ingredientTotals={};
    RATIONS.forEach(r=>{if(!/total/i.test(r.Ingredient))ingredientTotals[r.Ingredient]=0;});
    batch.sheds.forEach(s=>{
      RATIONS.forEach(r=>{
        if(/total/i.test(r.Ingredient))return;
        const q=r[s.shed.Ration];
        if(q!=null)ingredientTotals[r.Ingredient]+=q*s.percent*s.shed.Headcount;
      });
    });
    html+=`<table class="ingredient-table"><thead><tr><th></th><th>Ingredient</th><th>Qty (kg)</th><th>Cumulative Total (kg)</th></tr></thead><tbody>`;
    let cumulative=0;
    Object.entries(ingredientTotals).forEach(([ing,qty])=>{
      cumulative+=qty;
      html+=`<tr draggable="true"><td class="drag-handle">⋮⋮</td><td>${ing}</td><td>${Math.round(qty)}</td><td>${Math.round(cumulative)}</td></tr>`;
    });
    html+=`</tbody></table>`;
    out.innerHTML+=html;
  });

  document.querySelectorAll(".ingredient-table").forEach(makeIngredientTableDraggable);
  document.querySelectorAll(".shed-table").forEach(makeShedTableDraggable);
  document.getElementById("planOutput").scrollIntoView({behavior:"smooth"});
}

// ---------- DRAG & DROP ----------
function makeIngredientTableDraggable(table){ makeDraggable(table, 2, 3); }
function makeShedTableDraggable(table){ makeDraggable(table, 4, 5); }

function makeDraggable(table, qtyIndex, cumulativeIndex){
  const tbody=table.querySelector("tbody")||table;
  let dragRow=null,startY=0;
  tbody.querySelectorAll("tr").forEach(row=>{
    const handle=row.querySelector(".drag-handle");
    if(!handle)return;

    handle.addEventListener("dragstart",()=>{dragRow=row;row.style.opacity="0.5";});
    handle.addEventListener("dragend",()=>{row.style.opacity="";dragRow=null;});

    handle.addEventListener("touchstart",e=>{dragRow=row;startY=e.touches[0].clientY;row.style.opacity="0.5";});
    handle.addEventListener("touchmove",e=>{
      if(!dragRow)return;
      e.preventDefault();
      const y=e.touches[0].clientY;
      const rows=[...tbody.querySelectorAll("tr")];
      const over=rows.find(r=>{
        const rect=r.getBoundingClientRect();
        return y>rect.top && y<rect.bottom;
      });
      if(over&&over!==dragRow){
        if(y<over.getBoundingClientRect().top+over.offsetHeight/2)
          tbody.insertBefore(dragRow,over);
        else tbody.insertBefore(dragRow,over.nextSibling);
      }
    });
    handle.addEventListener("touchend",()=>{
      if(dragRow){dragRow.style.opacity="";dragRow=null;recalcCumulative(tbody,qtyIndex,cumulativeIndex);}
    });
  });

  tbody.addEventListener("dragover",e=>e.preventDefault());
  tbody.addEventListener("drop",e=>{
    e.preventDefault();
    const target=e.target.closest("tr");
    if(dragRow&&target&&dragRow!==target){
      const rows=[...tbody.querySelectorAll("tr")];
      const dragIndex=rows.indexOf(dragRow);
      const dropIndex=rows.indexOf(target);
      if(dragIndex<dropIndex)tbody.insertBefore(dragRow,target.nextSibling);
      else tbody.insertBefore(dragRow,target);
      recalcCumulative(tbody,qtyIndex,cumulativeIndex);
    }
  });
}

function recalcCumulative(tbody,qtyIndex,cumulativeIndex){
  let run=tbody.classList.contains("shed-table")?getTotalBatch(tbody):0;
  if(tbody.classList.contains("shed-table")){
    tbody.querySelectorAll("tr").forEach(r=>{
      const val=parseFloat(r.children[qtyIndex].textContent)||0;
      run-=val;
      r.children[cumulativeIndex].textContent=Math.max(Math.round(run),0);
    });
  } else {
    let total=0;
    tbody.querySelectorAll("tr").forEach(r=>{
      const val=parseFloat(r.children[qtyIndex].textContent)||0;
      total+=val;
      r.children[cumulativeIndex].textContent=Math.round(total);
    });
  }
}
function getTotalBatch(tbody){
  let total=0;
  tbody.querySelectorAll("tr").forEach(r=>{
    const v=parseFloat(r.children[4].textContent)||0;
    total+=v;
  });
  return total;
}

// ---------- UTILITIES ----------
function printPlan(){window.print();}
function downloadPDF(){}
initInputs();
</script>
</body>
</html>