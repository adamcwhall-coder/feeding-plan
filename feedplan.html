<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Feeding Plan</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f4f7fb;
    margin: 0;
    padding: 0;
  }
  h1 {
    text-align: center;
    color: #2a6ebb;
    margin: 20px 0 10px;
  }
  #loader {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 60px;
    font-size: 18px;
    color: #555;
  }
  #inputs {
    display: none;
    max-width: 700px;
    margin: 0 auto;
    padding: 0 10px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
  }
  th {
    background: #2a6ebb;
    color: white;
    padding: 12px;
    text-align: left;
    font-size: 14px;
  }
  td {
    border-bottom: 1px solid #eee;
    padding: 10px;
    font-size: 14px;
  }
  tr:nth-child(even) { background: #f9f9f9; }
  input[type="number"] {
    width: 70px;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  .button {
    display: block;
    width: 90%;
    margin: 25px auto;
    padding: 12px;
    background: #2a6ebb;
    color: white;
    text-align: center;
    border-radius: 6px;
    text-decoration: none;
    font-size: 16px;
  }
  #planOutput {
    background: white;
    margin: 20px auto;
    padding: 20px;
    max-width: 700px;
    border-radius: 10px;
  }
  #totalHeadcount {
    text-align: center;
    margin-top: 5px;
    font-weight: 600;
  }
</style>
</head>
<body>

<h1>Feeding Plan</h1>
<div id="loader">Loading data… ⏳</div>

<div id="inputs">
  <div id="totalHeadcount"></div>
  <table>
    <thead>
      <tr>
        <th>Shed</th>
        <th>Ration</th>
        <th>Headcount</th>
        <th>% of Target</th>
      </tr>
    </thead>
    <tbody id="shedTable"></tbody>
  </table>
  <a href="#" class="button" onclick="generatePlan()">Generate Plan</a>
</div>

<div id="planOutput" style="display:none"></div>
<a href="#" class="button" style="display:none" id="pdfBtn" onclick="savePDF()">Save as PDF</a>

<script>
const RATIONS_URL = "https://script.google.com/macros/s/AKfycbz7xmhtWaSwMcKVqZuuSo1eIAGOTKjThMYuDxyzKi3CNZ-uK8qAd_4ojJkVk8o0iwk/exec"; // Apps Script URL for Rations sheet
const YESTERDAY_URL = "https://script.google.com/macros/s/AKfycbydhGdSJ52UomMLIP1GtxyVQe2dflny8PUIC5lfv0vIiqDis_AorTZr_MsbYWaPfCCI/exec"; // Apps Script URL for YesterdayFeed
const SHEDS_URL = "https://script.google.com/macros/s/AKfycbwgA3g-Ps70NR3oBcgv11PU9wPwWg2Q5J_QHVF-aZ_Ix6G6rvOkGoYtYh1gZsL0Ed1K/exec";

let RATIONS = [], SHEDS = [], YESTERDAY = {};

async function loadData(){
  const [rRes, sRes, yRes] = await Promise.all([
    fetch(RATIONS_URL),
    fetch(SHEDS_URL),
    fetch(YESTERDAY_URL)
  ]);

  const rData = await rRes.json();
  const sData = await sRes.json();
  const yData = await yRes.json();

  // Parse RATIONS
  const headers = rData[0].slice(1);
  RATIONS = rData.slice(1).map(row=>{
    const obj = {Ingredient: row[0]};
    headers.forEach((h,i)=> obj[h] = row[i+1]);
    return obj;
  });

  // Parse SHEDS
  SHEDS = sData.slice(1).map(r => ({
    Shed: r[0],
    Ration: r[1],
    Headcount: Number(r[2])||0
  }));

  // Parse Yesterday
  yData.slice(1).forEach(r => {
    const shed = r[0];
    let val = r[1];
    if(typeof val === "number") val = Math.round(val*100) + "%";
    if(!val || val === "No Data") val = "0%";
    YESTERDAY[shed] = val;
  });

  buildInputTable();
}

function buildInputTable(){
  const tbody = document.getElementById('shedTable');
  let total = 0;
  SHEDS.forEach((s,i)=>{
    total += s.Headcount;
    const y = YESTERDAY[s.Shed] || "0%";
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${s.Shed}</td>
        <td>${s.Ration}</td>
        <td>${s.Headcount || 0}</td>
        <td>
          <input type="number" id="shed${i}" placeholder="${y.replace('%','')}" step="1" min="0" max="100"> %
        </td>
      </tr>
    `);
  });
  document.getElementById('totalHeadcount').textContent = `Total Headcount: ${total}`;
  document.getElementById('loader').style.display = 'none';
  document.getElementById('inputs').style.display = 'block';
}

function generatePlan(){
  const percentages = SHEDS.map((s,i)=>{
    let v = document.getElementById(`shed${i}`).value.trim();
    if(!v) v = (YESTERDAY[s.Shed]||"0%").replace('%','');
    return parseFloat(v)||0;
  });

  let html = `<h2 style="color:#2a6ebb">Feeding Plan - ${new Date().toLocaleDateString()}</h2>`;

  const rationGroups = {};
  SHEDS.forEach((shed,i)=>{
    const pct = percentages[i]/100;
    if(!rationGroups[shed.Ration]) rationGroups[shed.Ration] = [];
    rationGroups[shed.Ration].push({shed, percent:pct});
  });

  Object.entries(rationGroups).forEach(([ration,sheds],idx)=>{
    html += `<h3 style="margin-top:25px;color:#2a6ebb">Mix ${idx+1} - ${ration}</h3>`;
    html += `<table><thead><tr>
      <th>Shed</th><th>%</th><th>Headcount</th>
    </tr></thead><tbody>`;
    sheds.forEach(s=>{
      html += `<tr><td>${s.shed.Shed}</td><td>${(s.percent*100).toFixed(0)}%</td><td>${s.shed.Headcount}</td></tr>`;
    });
    html += `</tbody></table>`;
  });

  document.getElementById('planOutput').innerHTML = html;
  document.getElementById('planOutput').style.display = 'block';
  document.getElementById('pdfBtn').style.display = 'block';
}

async function savePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const content = document.getElementById('planOutput');

  await doc.html(content, {
    callback: function (doc) {
      doc.save('FeedingPlan.pdf');
    },
    x: 10,
    y: 10,
    html2canvas: { scale: 0.8 }
  });
}

loadData();
</script>

</body>
</html>
