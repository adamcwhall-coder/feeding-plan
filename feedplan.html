function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const dateStr = new Date().toISOString().slice(0,10);

  // Load your farm photo
  const img = new Image();
  img.src = "B0F99C08-DC4F-4DC3-B300-4C431D475C46.jpeg"; // same folder as your HTML file

  img.onload = function () {
    // --- Cover Page ---
    doc.addImage(img, "JPEG", 35, 20, 140, 80); // Centered photo
    doc.setFontSize(22);
    doc.text("New Blainslie Feeding Plan", 105, 115, { align: "center" });

    doc.setFontSize(14);
    doc.text(`Date: ${dateStr}`, 105, 130, { align: "center" });
    doc.text(`Total Headcount: ${TOTAL_HEADCOUNT}`, 105, 145, { align: "center" });

    doc.setFontSize(11);
    doc.text("Generated automatically", 105, 160, { align: "center" });

    // Start new page for plan details
    doc.addPage();

    PLAN.forEach((batch, idx) => {
      if (idx > 0) doc.addPage();

      doc.setFontSize(14);
      doc.text(`Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg`, 14, 20);

      // Shed table
      doc.autoTable({
        startY: 30,
        head: [["Shed", "%", "Headcount", "Total (kg)"]],
        body: batch.sheds.map(s => [s.shed.Shed, s.percentStr, Math.round(s.shed.Headcount), Math.round(s.total)]),
        theme: "striped",
        headStyles: { fillColor: [42, 110, 187], halign: "center" },
        styles: { halign: "center" }
      });

      // Ingredients
      const ingredientTotals = {};
      RATIONS.forEach(r=>{ if(!/total/i.test(r.Ingredient)) ingredientTotals[r.Ingredient]=0; });
      batch.sheds.forEach(s=>{
        RATIONS.forEach(r=>{
          if (/total/i.test(r.Ingredient)) return;
          const q = r[s.shed.Ration];
          if (q != null) ingredientTotals[r.Ingredient] += q * s.percent * s.shed.Headcount;
        });
      });

      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head: [["Ingredient", "Quantity (kg)"]],
        body: Object.entries(ingredientTotals).map(([ing, qty]) => [ing, Math.round(qty)]),
        theme: "grid",
        headStyles: { fillColor: [42, 110, 187], halign: "center" },
        styles: { halign: "center" }
      });
    });

    doc.save(`feeding_plan_${dateStr}.pdf`);
  };
}