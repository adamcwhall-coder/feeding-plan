<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Blainslie Feeding Plan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; color: #2a6ebb; }
    input { width: 60px; padding: 5px; margin: 3px; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #2a6ebb; color: white; }
    button { margin: 10px 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; }
    #generateBtn { background: #2a6ebb; color: white; }
    #printBtn { background: #4CAF50; color: white; }
    #pdfBtn { background: #f39c12; color: white; }
    #planOutput { margin-top: 30px; }
  </style>
</head>
<body>

  <h1>New Blainslie Feeding Plan</h1>

  <div id="inputs"></div>
  <button id="generateBtn" onclick="generatePlan()">Generate Plan</button>

  <div id="planOutput" style="display:none;">
    <button id="printBtn" onclick="window.print()">Print</button>
    <button id="pdfBtn" onclick="downloadPDF()">Download PDF</button>
  </div>

<script>
const RATIONS = [
  {Ingredient:"Barley",R1:2.5,R2:2.0},
  {Ingredient:"Silage",R1:25,R2:30},
  {Ingredient:"Total",R1:27.5,R2:32}
];
const SHEDS = [
  {Shed:"Shed 1",Headcount:20,Ration:"R1"},
  {Shed:"Shed 2",Headcount:15,Ration:"R2"}
];
const MAX_BATCH = 5000;
let PLAN=[], TOTAL_HEADCOUNT=SHEDS.reduce((a,b)=>a+b.Headcount,0);

function computeShedTotal(shed, percent){
  let total=0;
  RATIONS.forEach(r=>{
    if(/total/i.test(r.Ingredient)){
      total+= (r[shed.Ration]||0)*percent*shed.Headcount;
    }
  });
  return total;
}

function generatePlan(){
  const percentages = SHEDS.map((s,i)=>parseFloat(document.getElementById("shed"+i).value||document.getElementById("shed"+i).placeholder)/100||0);
  const rationGroups = {};
  SHEDS.forEach((shed,i)=>{
    const percent = percentages[i];
    const total = computeShedTotal(shed, percent);
    if(!rationGroups[shed.Ration]) rationGroups[shed.Ration]=[];
    rationGroups[shed.Ration].push({shed, percent, total, percentStr:(percent*100).toFixed(0)+"%"});
  });

  PLAN=[];
  Object.entries(rationGroups).forEach(([rationType,sheds])=>{
    sheds.sort((a,b)=>b.total-a.total);
    let batches=[], current={sheds:[], total:0};
    sheds.forEach(s=>{
      if (s.total+current.total<=MAX_BATCH || current.sheds.length===0){ 
        current.sheds.push(s); current.total+=s.total; 
      } else { 
        batches.push(current); current={sheds:[s], total:s.total}; 
      }
    });
    if(current.sheds.length>0) batches.push(current);
    batches.forEach((batch,idx)=>PLAN.push({rationType, idx:idx+1, sheds:batch.sheds, total:batch.total}));
  });

  const output=document.getElementById("planOutput");
  output.style.display="block";
  output.innerHTML=`<button id="printBtn" onclick="window.print()">Print</button>
                    <button id="pdfBtn" onclick="downloadPDF()">Download PDF</button>
                    <h2>Date: ${new Date().toISOString().slice(0,10)}</h2>`;
  PLAN.forEach(batch=>{
    let html=`<h3>Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg</h3>`;
    html+=`<table><tr><th>Shed</th><th>%</th><th>Headcount</th><th>Total (kg)</th></tr>`;
    batch.sheds.forEach(s=>{
      html+=`<tr><td>${s.shed.Shed}</td><td>${s.percentStr}</td><td>${Math.round(s.shed.Headcount)}</td><td>${Math.round(s.total)}</td></tr>`;
    });
    html+=`</table>`;
    const ingredientTotals={};
    RATIONS.forEach(r=>{ if(!/total/i.test(r.Ingredient)) ingredientTotals[r.Ingredient]=0; });
    batch.sheds.forEach(s=>{
      RATIONS.forEach(r=>{
        if(/total/i.test(r.Ingredient)) return;
        const q=r[s.shed.Ration];
        if(q!=null) ingredientTotals[r.Ingredient]+=q*s.percent*s.shed.Headcount;
      });
    });
    html+=`<table><tr><th>Ingredient</th><th>Quantity (kg)</th></tr>`;
    Object.entries(ingredientTotals).forEach(([ing,qty])=>{
      html+=`<tr><td>${ing}</td><td>${Math.round(qty)}</td></tr>`;
    });
    html+=`</table>`;
    output.innerHTML+=html;
  });

  // ðŸ‘‡ Scroll smoothly down to results
  document.getElementById("planOutput").scrollIntoView({ behavior: "smooth" });
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const dateStr = new Date().toISOString().slice(0,10);

  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = "https://raw.githubusercontent.com/adamcwhall-coder/feeding-plan/main/IMG_2691.jpeg";

  img.onload = function(){
    doc.addImage(img, "JPEG", 35, 20, 140, 80);
    doc.setFontSize(22);
    doc.text("New Blainslie Feeding Plan", 105, 115, { align: "center" });
    doc.setFontSize(14);
    doc.text(`Date: ${dateStr}`, 105, 130, { align: "center" });
    doc.text(`Total Headcount: ${TOTAL_HEADCOUNT}`, 105, 145, { align: "center" });

    doc.addPage();

    PLAN.forEach((batch, idx)=>{
      if(idx>0) doc.addPage();
      doc.setFontSize(14);
      doc.text(`Mix ${batch.idx} - ${batch.rationType} - Total: ${Math.round(batch.total)} kg`, 14, 20);

      doc.autoTable({
        startY: 30,
        head: [["Shed","%","Headcount","Total (kg)"]],
        body: batch.sheds.map(s=>[s.shed.Shed,s.percentStr,Math.round(s.shed.Headcount),Math.round(s.total)]),
        theme: "striped",
        headStyles: { fillColor:[42,110,187], halign:"center" },
        styles: { halign:"center" }
      });

      const ingredientTotals={};
      RATIONS.forEach(r=>{ if(!/total/i.test(r.Ingredient)) ingredientTotals[r.Ingredient]=0; });
      batch.sheds.forEach(s=>{
        RATIONS.forEach(r=>{
          if(/total/i.test(r.Ingredient)) return;
          const q=r[s.shed.Ration];
          if(q!=null) ingredientTotals[r.Ingredient]+=q*s.percent*s.shed.Headcount;
        });
      });

      doc.autoTable({
        startY: doc.lastAutoTable.finalY+10,
        head: [["Ingredient","Quantity (kg)"]],
        body: Object.entries(ingredientTotals).map(([ing,qty])=>[ing,Math.round(qty)]),
        theme: "grid",
        headStyles: { fillColor:[42,110,187], halign:"center" },
        styles: { halign:"center" }
      });
    });

    doc.save(`feeding_plan_${dateStr}.pdf`);
  };
}
</script>

<script>
// Build input fields for each shed
window.onload = () => {
  const inputDiv=document.getElementById("inputs");
  SHEDS.forEach((s,i)=>{
    inputDiv.innerHTML+=`<label>${s.Shed} (%): <input type="number" id="shed${i}" placeholder="100"></label><br>`;
  });
};
</script>

</body>
</html>